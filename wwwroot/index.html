<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebServer HLS Player Test</title>
    <!-- 1. å¼•å…¥ hls.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --header-bg: #1c1c1c;
            --text-main: #f1f1f1;
            --text-sec: #aaaaaa;
            --accent: #3ea6ff;
            --border: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg-color); color: var(--text-main); overflow-x: hidden; }

        header {
            height: 56px;
            background-color: var(--header-bg);
            display: flex;
            align-items: center;
            padding: 0 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }
        .logo { font-weight: bold; font-size: 20px; color: var(--text-main); display: flex; align-items: center; gap: 5px; }
        .logo span { color: #ff0033; }
        .search-bar { flex: 1; max-width: 600px; margin: 0 auto; display: flex; }
        .search-input { 
            width: 100%; background: #121212; border: 1px solid #333; padding: 8px; color: white; border-radius: 20px 0 0 20px; outline: none; 
        }
        .search-btn {
            background: #333; border: 1px solid #333; padding: 0 20px; border-radius: 0 20px 20px 0; cursor: pointer; color: #aaa;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 24px;
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .video-section { display: flex; flex-direction: column; }
        
        .player-wrapper {
            width: 100%;
            aspect-ratio: 16 / 9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        }

        video {
            width: 100%;
            height: 100%;
            display: block;
        }

        .video-info { margin-top: 12px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
        .video-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .video-meta { display: flex; justify-content: space-between; color: var(--text-sec); font-size: 14px; }
        .actions { display: flex; gap: 15px; }
        .action-btn { cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 500; }
        .action-btn:hover { color: var(--text-main); }

        .sidebar { display: flex; flex-direction: column; gap: 10px; }
        .rec-card { display: flex; gap: 8px; cursor: pointer; }
        .rec-thumb { width: 168px; height: 94px; background: #333; border-radius: 8px; }
        .rec-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .rec-title { font-size: 14px; font-weight: 600; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .rec-meta { font-size: 12px; color: var(--text-sec); }

        .debug-panel {
            margin-top: 20px;
            background: #1c1c1c;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .debug-header { color: var(--accent); font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;}
        .log-box { height: 200px; overflow-y: auto; color: #0f0; }
        .log-entry { margin-bottom: 2px; word-break: break-all; }
        .log-warn { color: #ffcc00; }
        .log-err { color: #ff3333; }
        .log-hls { color: #00ccff; }

        @media (max-width: 1000px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo"><span>â–¶</span> MyTube HLS</div>
        <div class="search-bar">
            <!-- é»˜è®¤å»ºè®®è¾“å…¥ .m3u8 è·¯å¾„ -->
            <input type="text" class="search-input" value="/video/index.m3u8" placeholder="è¾“å…¥ .m3u8 æˆ– .mp4 è·¯å¾„...">
            <button class="search-btn">ğŸ”</button>
        </div>
        <div style="width: 32px; height: 32px; background: #555; border-radius: 50%; margin-left: 20px;"></div>
    </header>

    <div class="container">
        <div class="video-section">
            <div class="player-wrapper">
                <!-- Video æ ‡ç­¾ä¸éœ€è¦ Sourceï¼Œäº¤ç»™ JS æ§åˆ¶ -->
                <video id="myVideo" controls crossorigin="anonymous"></video>
            </div>

            <div class="video-info">
                <div class="video-title">C++ WebServer HLS æµåª’ä½“æµ‹è¯•</div>
                <div class="video-meta">
                    <span>HLS (m3u8) æ¨¡å¼ â€¢ æé€ŸåŠ è½½</span>
                    <div class="actions">
                        <div class="action-btn">ğŸ‘ 1024</div>
                        <div class="action-btn">ğŸ‘ 0</div>
                        <div class="action-btn">â†— åˆ†äº«</div>
                    </div>
                </div>
            </div>

            <div class="debug-panel">
                <div class="debug-header">ğŸ› ï¸ æ’­æ”¾å™¨è°ƒè¯•æ—¥å¿— (HLS/Event)</div>
                <div class="log-box" id="logBox">
                    <div class="log-entry">ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ...</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; color: var(--text-sec); line-height: 1.6;">
                <h3>æµ‹è¯•è¯´æ˜ï¼š</h3>
                <p>1. é»˜è®¤åŠ è½½ <b>/video/index.m3u8</b> (è¯·ç¡®ä¿æœåŠ¡å™¨æœ‰æ­¤æ–‡ä»¶)ã€‚</p>
                <p>2. è§‚å¯Ÿæ—¥å¿—ï¼šHLS æ¨¡å¼ä¸‹ä¼šçœ‹åˆ° ".ts" åˆ‡ç‰‡ä¸‹è½½æ—¥å¿—ã€‚</p>
                <p>3. å…¼å®¹æ€§ï¼šå¦‚æœè¾“å…¥ .mp4 æ–‡ä»¶ï¼Œä¼šè‡ªåŠ¨é™çº§ä¸ºåŸç”Ÿ Range è¯·æ±‚æ’­æ”¾ã€‚</p>
            </div>
        </div>

        <div class="sidebar">
            <div class="rec-card" onclick="playUrl('/test.mp4')">
                <div class="rec-thumb" style="background: #444; display:flex; align-items:center; justify-content:center; color:#888;">MP4</div>
                <div class="rec-info">
                    <div class="rec-title">æµ‹è¯• MP4 å›é€€å…¼å®¹æ€§</div>
                    <div class="rec-meta">Range Test<br>Legacy Mode</div>
                </div>
            </div>
            <div class="rec-card" onclick="playUrl('/video/index.m3u8')">
                <div class="rec-thumb" style="background: #555; display:flex; align-items:center; justify-content:center; color:#3ea6ff;">HLS</div>
                <div class="rec-info">
                    <div class="rec-title">é‡æ–°åŠ è½½ HLS è§†é¢‘</div>
                    <div class="rec-meta">m3u8 Mode<br>High Performance</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('myVideo');
        const logBox = document.getElementById('logBox');
        const searchBtn = document.querySelector('.search-btn');
        const searchInput = document.querySelector('.search-input');
        
        let hls = null; // å…¨å±€ HLS å¯¹è±¡

        // æ—¥å¿—åŠŸèƒ½
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.textContent = `[${time}] ${msg}`;
            div.className = 'log-entry';
            if(type === 'warn') div.classList.add('log-warn');
            if(type === 'error') div.classList.add('log-err');
            if(type === 'hls') div.classList.add('log-hls');
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
        }

        // æ ¸å¿ƒæ’­æ”¾é€»è¾‘
        function playUrl(url) {
            if(!url) return;
            
            // æ›´æ–° UI
            document.querySelector('.video-title').textContent = url;
            searchInput.value = url;
            log(`å‡†å¤‡åŠ è½½: ${url}`, 'warn');

            // 1. å¦‚æœä¹‹å‰æœ‰ HLS å®ä¾‹ï¼Œé”€æ¯å®ƒ
            if (hls) {
                hls.destroy();
                hls = null;
            }

            // 2. åˆ¤æ–­æ˜¯å¦æ˜¯ m3u8
            if (url.endsWith('.m3u8')) {
                // === HLS é€»è¾‘ ===
                if (Hls.isSupported()) {
                    log('æ£€æµ‹åˆ° m3u8ï¼Œä½¿ç”¨ HLS.js å¼•æ“', 'hls');
                    hls = new Hls({
                        debug: false, // å¼€å¯ HLS å†…éƒ¨è°ƒè¯•å¯è®¾ä¸º true
                        enableWorker: true, // å¼€å¯å¤šçº¿ç¨‹ Worker
                        lowLatencyMode: true // ä½å»¶è¿Ÿæ¨¡å¼
                    });
                    
                    hls.loadSource(url);
                    hls.attachMedia(video);

                    // ç»‘å®š HLS äº‹ä»¶ç”¨äºæ—¥å¿—
                    hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                        log(`HLS ç´¢å¼•è§£ææˆåŠŸï¼Œå…± ${data.levels.length} ä¸ªæ¸…æ™°åº¦ï¼Œå¼€å§‹æ’­æ”¾`, 'hls');
                        video.play().catch(e => log('è‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆªï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾', 'warn'));
                    });
                    
                    hls.on(Hls.Events.FRAG_LOADED, (event, data) => {
                        // æ‰“å°åˆ‡ç‰‡åŠ è½½ä¿¡æ¯ï¼Œè¯æ˜æ˜¯åˆ†ç‰‡ä¸‹è½½
                        log(`â¬‡ï¸ åˆ‡ç‰‡ä¸‹è½½å®Œæˆ: sn=${data.frag.sn}, dur=${data.frag.duration}s, size=${(data.stats.total/1024).toFixed(1)}KB`, 'hls');
                    });

                    hls.on(Hls.Events.ERROR, function (event, data) {
                        if (data.fatal) {
                            switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                log('HLS ç½‘ç»œé”™è¯¯ï¼Œå°è¯•æ¢å¤...', 'error');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                log('HLS åª’ä½“è§£ç é”™è¯¯ï¼Œå°è¯•æ¢å¤...', 'error');
                                hls.recoverMediaError();
                                break;
                            default:
                                log('HLS è‡´å‘½é”™è¯¯ï¼Œæ— æ³•æ¢å¤', 'error');
                                hls.destroy();
                                break;
                            }
                        }
                    });

                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    // === Safari åŸç”Ÿæ”¯æŒ HLS ===
                    log('æ£€æµ‹åˆ° Safari ç¯å¢ƒï¼Œä½¿ç”¨åŸç”Ÿ HLS æ”¯æŒ', 'hls');
                    video.src = url;
                    video.addEventListener('loadedmetadata', () => {
                        video.play();
                    });
                } else {
                    log('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ HLS (m3u8) æ’­æ”¾', 'error');
                }
            } else {
                // === æ™®é€š MP4 (Range) é€»è¾‘ ===
                log('æ£€æµ‹åˆ°æ™®é€šæ–‡ä»¶ï¼Œä½¿ç”¨åŸç”Ÿ Video æ ‡ç­¾æ’­æ”¾ (Range Mode)');
                video.src = url;
                video.load();
                video.play();
            }
        }

        // æœç´¢æ é€»è¾‘
        searchBtn.onclick = () => playUrl(searchInput.value.trim());
        searchInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') playUrl(searchInput.value.trim()); });

        // åŸç”Ÿ Video äº‹ä»¶ç›‘å¬ (é€šç”¨çš„)
        video.addEventListener('waiting', () => log('âŒ› ç¼“å†²ä¸­...'));
        video.addEventListener('playing', () => log('â–¶ï¸ æ’­æ”¾ä¸­'));
        video.addEventListener('pause', () => log('â¸ï¸ æš‚åœ'));
        video.addEventListener('error', () => {
            if(video.error) log(`âŒ æ’­æ”¾å™¨é”™è¯¯: code=${video.error.code}, msg=${video.error.message}`, 'error');
        });

        // é¡µé¢åŠ è½½é»˜è®¤æ’­æ”¾
        window.onload = () => {
            // å°è¯•åŠ è½½é»˜è®¤çš„ m3u8
            playUrl(searchInput.value.trim());
        }
    </script>
</body>
</html>